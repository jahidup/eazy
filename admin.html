<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <title>EasyShop ‚Äì Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { background: linear-gradient(145deg, #f1f5f9 0%, #e6edf4 100%); font-family: 'Inter', system-ui, sans-serif; }
    .glass-panel { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 20px 40px -12px rgba(0,0,0,0.06); }
    .tab-active { border-bottom: 3px solid #3b82f6; color: #1e40af; font-weight: 600; background: rgba(59,130,246,0.06); }
    .btn-primary { background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; padding: 0.5rem 1.8rem; border-radius: 100px; font-weight: 500; transition: all 0.2s; box-shadow: 0 10px 20px -8px #3b82f6; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 16px 24px -10px #2563eb; }
    .btn-secondary { background: white; border: 1px solid #e2e8f0; color: #1e293b; padding: 0.5rem 1.8rem; border-radius: 100px; font-weight: 500; transition: all 0.2s; }
    .btn-secondary:hover { background: #f8fafc; border-color: #94a3b8; }
    .table-header { background: #f1f5f9; color: #0f172a; font-weight: 600; }
    .toast { animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .loading-dots { display: inline-flex; align-items: center; gap: 6px; }
    .loading-dots span { width: 10px; height: 10px; background: #3b82f6; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%,80%,100% { transform: scale(0); } 40% { transform: scale(1); } }
  </style>
</head>
<body class="p-6">

  <!-- ========== LOGIN OVERLAY ========== -->
  <div id="loginOverlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass-panel max-w-md w-full p-8 rounded-3xl">
      <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-700 bg-clip-text text-transparent mb-6">üîê Admin Login</h2>
      <input type="password" id="adminPassword" placeholder="Enter admin password" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500">
      <button onclick="adminLogin()" id="adminLoginBtn" class="btn-primary w-full py-3">Login</button>
      <p class="text-xs text-gray-500 mt-4 text-center">Default: <span class="font-mono bg-gray-100 px-2 py-1 rounded">admin123</span></p>
    </div>
  </div>

  <!-- ========== MAIN ADMIN CONTENT ========== -->
  <div id="adminContent" class="hidden max-w-7xl mx-auto space-y-6">

    <!-- Header -->
    <div class="flex justify-between items-center">
      <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-700 bg-clip-text text-transparent">
        <i class="fas fa-crown mr-2"></i>EasyShop Admin
      </h1>
      <button onclick="logoutAdmin()" class="btn-secondary flex items-center gap-2">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 border-b border-gray-200 pb-1">
      <button data-tab="dashboard" class="tab-btn px-5 py-2.5 rounded-t-xl text-gray-600 hover:bg-gray-100 transition flex items-center gap-2"><i class="fas fa-chart-pie"></i> Dashboard</button>
      <button data-tab="products" class="tab-btn px-5 py-2.5 rounded-t-xl text-gray-600 hover:bg-gray-100 transition flex items-center gap-2"><i class="fas fa-box"></i> Products</button>
      <button data-tab="orders" class="tab-btn px-5 py-2.5 rounded-t-xl text-gray-600 hover:bg-gray-100 transition flex items-center gap-2"><i class="fas fa-truck"></i> Orders</button>
      <button data-tab="settings" class="tab-btn px-5 py-2.5 rounded-t-xl text-gray-600 hover:bg-gray-100 transition flex items-center gap-2"><i class="fas fa-cog"></i> Settings</button>
    </div>

    <!-- Dashboard Pane -->
    <div id="dashboardPane" class="tab-pane hidden">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="glass-panel rounded-2xl p-6"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 text-xl"><i class="fas fa-boxes"></i></div><div><p class="text-gray-500 text-sm">Total Products</p><h3 id="statsProducts" class="text-3xl font-bold">0</h3></div></div></div>
        <div class="glass-panel rounded-2xl p-6"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 text-xl"><i class="fas fa-shopping-cart"></i></div><div><p class="text-gray-500 text-sm">Total Orders</p><h3 id="statsOrders" class="text-3xl font-bold">0</h3></div></div></div>
        <div class="glass-panel rounded-2xl p-6"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 text-xl"><i class="fas fa-rupee-sign"></i></div><div><p class="text-gray-500 text-sm">Total Revenue</p><h3 id="statsRevenue" class="text-3xl font-bold">‚Çπ0</h3></div></div></div>
      </div>
      <div class="glass-panel rounded-2xl p-6 mt-6">
        <h3 class="font-semibold text-lg mb-4 flex items-center gap-2"><i class="fas fa-clock text-blue-600"></i> Recent Orders</h3>
        <div id="recentOrdersList" class="overflow-x-auto"><div class="flex justify-center py-8"><div class="loading-dots"><span></span><span></span><span></span></div></div></div>
      </div>
    </div>

    <!-- Products Pane -->
    <div id="productsPane" class="tab-pane hidden">
      <div class="glass-panel rounded-2xl p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
          <h3 class="font-semibold text-lg"><i class="fas fa-box mr-2"></i>Product Management</h3>
          <div class="flex gap-3 w-full md:w-auto">
            <div class="relative flex-1 md:w-64"><i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="text" id="productSearch" placeholder="Search by ID or name..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"></div>
            <button onclick="openAddProductModal()" class="btn-primary text-sm flex items-center gap-2 whitespace-nowrap"><i class="fas fa-plus"></i> Add Product</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="table-header"><tr><th class="p-3 text-left">ID</th><th class="p-3 text-left">Image</th><th class="p-3 text-left">Name</th><th class="p-3 text-left">Price</th><th class="p-3 text-left">Disc.</th><th class="p-3 text-left">Final</th><th class="p-3 text-left">Stock</th><th class="p-3 text-left">Category</th><th class="p-3 text-left">Actions</th></tr></thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Orders Pane -->
    <div id="ordersPane" class="tab-pane hidden">
      <div class="glass-panel rounded-2xl p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
          <h3 class="font-semibold text-lg"><i class="fas fa-truck mr-2"></i>Order Management</h3>
          <div class="flex gap-3 w-full md:w-auto">
            <select id="orderStatusFilter" class="px-4 py-2 border border-gray-200 rounded-xl bg-white"><option value="">All Status</option><option value="Pending">Pending</option><option value="Shipped">Shipped</option><option value="Delivered">Delivered</option><option value="Cancelled">Cancelled</option></select>
            <div class="relative flex-1 md:w-64"><i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="text" id="orderSearch" placeholder="Search by order ID, customer..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"></div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="table-header"><tr><th class="p-3 text-left">Order ID</th><th class="p-3 text-left">Customer</th><th class="p-3 text-left">Total</th><th class="p-3 text-left">Status</th><th class="p-3 text-left">Date</th><th class="p-3 text-left">Actions</th></tr></thead>
            <tbody id="ordersTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Settings Pane -->
    <div id="settingsPane" class="tab-pane hidden">
      <div class="glass-panel rounded-2xl p-6 max-w-md">
        <h3 class="font-semibold text-lg mb-4 flex items-center gap-2"><i class="fas fa-lock text-blue-600"></i> Change Admin Password</h3>
        <input type="password" id="newAdminPassword" placeholder="New password" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-4">
        <button onclick="updateAdminPassword()" class="btn-primary w-full">Update Password</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 bg-white shadow-xl rounded-xl px-6 py-4 hidden items-center gap-3 toast z-50"></div>

  <!-- Product Modal -->
  <div id="productModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50 overflow-y-auto p-4">
    <div class="glass-panel max-w-2xl w-full p-8 rounded-3xl max-h-[90vh] overflow-y-auto">
      <h3 id="productModalTitle" class="text-xl font-bold mb-4">‚ûï Add Product</h3>
      <input type="hidden" id="editMode" value="add">
      <input type="hidden" id="editProductId" value="">
      <div class="grid grid-cols-2 gap-4">
        <div class="col-span-2 md:col-span-1"><label class="text-sm text-gray-600">Product ID</label><input id="productIdInput" placeholder="e.g. P003" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div class="col-span-2 md:col-span-1"><label class="text-sm text-gray-600">Category</label><input id="productCategoryInput" placeholder="e.g. Electronics" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div class="col-span-2"><label class="text-sm text-gray-600">Product Name</label><input id="productNameInput" placeholder="Name" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div class="col-span-2"><label class="text-sm text-gray-600">Description</label><textarea id="productDescInput" rows="2" placeholder="Product description" class="w-full px-4 py-2 border rounded-xl mt-1"></textarea></div>
        <div><label class="text-sm text-gray-600">Price (‚Çπ)</label><input id="productPriceInput" type="number" step="0.01" placeholder="799" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div><label class="text-sm text-gray-600">Discount (%)</label><input id="productDiscountInput" type="number" step="0.01" placeholder="20" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div><label class="text-sm text-gray-600">Stock</label><input id="productStockInput" type="number" placeholder="50" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div class="col-span-2"><label class="text-sm text-gray-600">Image URL</label><input id="productImageInput" placeholder="https://..." class="w-full px-4 py-2 border rounded-xl mt-1"></div>
      </div>
      <div class="flex gap-3 mt-6"><button onclick="saveProduct()" id="saveProductBtn" class="btn-primary flex-1">Save Product</button><button onclick="closeModal('productModal')" class="btn-secondary flex-1">Cancel</button></div>
    </div>
  </div>

  <!-- Order Items Modal -->
  <div id="orderItemsModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="glass-panel max-w-lg w-full p-6 rounded-3xl"><h3 class="text-xl font-bold mb-4">üõí Order Items</h3><div id="orderItemsList" class="space-y-3 max-h-80 overflow-y-auto"></div><div class="flex justify-end mt-6"><button onclick="closeModal('orderItemsModal')" class="btn-secondary px-6">Close</button></div></div>
  </div>

  <!-- Update Status Modal -->
  <div id="updateStatusModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="glass-panel max-w-md w-full p-6 rounded-3xl">
      <h3 class="text-xl font-bold mb-4">üì¶ Update Order Status</h3>
      <input type="hidden" id="statusOrderId">
      <select id="newOrderStatus" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-4"><option value="Pending">Pending</option><option value="Shipped">Shipped</option><option value="Delivered">Delivered</option><option value="Cancelled">Cancelled</option></select>
      <div class="flex gap-3"><button onclick="updateOrderStatus()" id="updateStatusBtn" class="btn-primary flex-1">Update</button><button onclick="closeModal('updateStatusModal')" class="btn-secondary flex-1">Cancel</button></div>
    </div>
  </div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby54pp2zta41iEJaE-7c82dvs0Y-ul8iZsfxlqjwa1VrJ9Z7XUdSeBAXyjB7uh6bLc/exec';
    let adminToken = localStorage.getItem('adminToken');
    let allProducts = [], allOrders = [];

    // Helpers
    function showLoading(btnId) { const btn = document.getElementById(btnId); if(btn){ btn.disabled = true; btn.innerHTML = `<div class="loading-dots"><span></span><span></span><span></span></div>`; } }
    function hideLoading(btnId, text) { const btn = document.getElementById(btnId); if(btn){ btn.disabled = false; btn.innerHTML = text; } }
    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      toast.className = `fixed bottom-6 right-6 bg-white shadow-xl rounded-xl px-6 py-4 flex items-center gap-3 toast z-50 ${type==='error'?'border-l-4 border-red-500':'border-l-4 border-green-500'}`;
      toast.innerHTML = `<i class="fas ${type==='error'?'fa-exclamation-circle text-red-500':'fa-check-circle text-green-500'}"></i>${msg}`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    // Admin Login
    async function adminLogin() {
      const pwd = document.getElementById('adminPassword').value;
      showLoading('adminLoginBtn');
      const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'adminLogin', password: pwd }) });
      const data = await res.json();
      if (data.status === 'success') {
        adminToken = data.token; localStorage.setItem('adminToken', adminToken);
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('adminContent').classList.remove('hidden');
        loadDashboard(); loadProducts(); loadOrders();
      } else showToast('Invalid password', 'error');
      hideLoading('adminLoginBtn', 'Login');
    }

    // Auto-login if token exists
    if (adminToken) { document.getElementById('loginOverlay').classList.add('hidden'); document.getElementById('adminContent').classList.remove('hidden'); window.onload = () => { loadDashboard(); loadProducts(); loadOrders(); }; }

    function logoutAdmin() { localStorage.removeItem('adminToken'); location.reload(); }

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        this.classList.add('tab-active');
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
        document.getElementById(this.dataset.tab + 'Pane').classList.remove('hidden');
        if (this.dataset.tab === 'products') loadProducts();
        if (this.dataset.tab === 'orders') loadOrders();
        if (this.dataset.tab === 'dashboard') loadDashboard();
      });
    });

    // Dashboard
    async function loadDashboard() {
      try {
        const statsRes = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getDashboardStats', token: adminToken }) });
        const stats = await statsRes.json();
        if (stats.status === 'success') {
          document.getElementById('statsProducts').innerText = stats.data.totalProducts || 0;
          document.getElementById('statsOrders').innerText = stats.data.totalOrders || 0;
          document.getElementById('statsRevenue').innerHTML = `‚Çπ${(stats.data.totalRevenue || 0).toFixed(0)}`;
        }
        const ordersRes = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllOrders', token: adminToken }) });
        const ordersData = await ordersRes.json();
        if (ordersData.status === 'success') {
          const recent = ordersData.data.slice(-5).reverse();
          let html = '';
          recent.forEach(o => { html += `<tr class="border-b"><td class="p-2">${o.orderId}</td><td class="p-2">${o.customerName}</td><td class="p-2">‚Çπ${o.total}</td><td class="p-2"><span class="px-2 py-1 rounded-full text-xs ${getStatusColor(o.status)}">${o.status}</span></td><td class="p-2">${new Date(o.date).toLocaleDateString()}</td></tr>`; });
          document.getElementById('recentOrdersList').innerHTML = `<table class="w-full text-sm"><thead class="table-header"><tr><th class="p-2 text-left">Order ID</th><th class="p-2 text-left">Customer</th><th class="p-2 text-left">Total</th><th class="p-2 text-left">Status</th><th class="p-2 text-left">Date</th></tr></thead><tbody>${html}</tbody></table>`;
        }
      } catch(e) { console.error(e); }
    }
    function getStatusColor(status) {
      switch(status) {
        case 'Pending': return 'bg-yellow-100 text-yellow-800';
        case 'Shipped': return 'bg-blue-100 text-blue-800';
        case 'Delivered': return 'bg-green-100 text-green-800';
        case 'Cancelled': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    // Products
    async function loadProducts() {
      try {
        const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllProducts' }) });
        const data = await res.json();
        if (data.status === 'success') { allProducts = data.data; renderProductsTable(allProducts); }
        else showToast('Failed to load products', 'error');
      } catch(e) { showToast('Network error', 'error'); }
    }
    function renderProductsTable(products) {
      let html = '';
      products.forEach(p => {
        html += `<tr class="border-b">
          <td class="p-3">${p.id}</td>
          <td class="p-3"><img src="${p.imageUrl || 'https://via.placeholder.com/50'}" class="w-12 h-12 object-cover rounded border"></td>
          <td class="p-3">${p.name}</td>
          <td class="p-3">‚Çπ${p.price}</td>
          <td class="p-3">${p.discount}%</td>
          <td class="p-3 font-bold text-blue-600">‚Çπ${p.finalPrice.toFixed(0)}</td>
          <td class="p-3">${p.stock}</td>
          <td class="p-3">${p.category}</td>
          <td class="p-3">
            <button onclick="openEditProductModal('${p.id}')" class="text-indigo-600 hover:text-indigo-800 mr-2" title="Edit"><i class="fas fa-edit"></i></button>
            <button onclick="deleteProduct('${p.id}')" class="text-red-600 hover:text-red-800" title="Delete"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
      });
      document.getElementById('productsTableBody').innerHTML = html || '<tr><td colspan="9" class="p-6 text-center text-gray-500">No products found.</td></tr>';
    }
    // Search listener
    document.getElementById('productSearch')?.addEventListener('input', function(e) {
      const term = e.target.value.toLowerCase();
      const filtered = allProducts.filter(p => p.id.toLowerCase().includes(term) || p.name.toLowerCase().includes(term));
      renderProductsTable(filtered);
    });

    function openAddProductModal() {
      document.getElementById('editMode').value = 'add';
      document.getElementById('productModalTitle').innerText = '‚ûï Add Product';
      ['productIdInput','productNameInput','productDescInput','productPriceInput','productDiscountInput','productStockInput','productCategoryInput','productImageInput'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('editProductId').value = '';
      document.getElementById('productModal').style.display = 'flex';
    }
    function openEditProductModal(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) return showToast('Product not found', 'error');
      document.getElementById('editMode').value = 'edit';
      document.getElementById('productModalTitle').innerText = '‚úèÔ∏è Edit Product';
      document.getElementById('productIdInput').value = product.id;
      document.getElementById('productNameInput').value = product.name;
      document.getElementById('productDescInput').value = product.description;
      document.getElementById('productPriceInput').value = product.price;
      document.getElementById('productDiscountInput').value = product.discount;
      document.getElementById('productStockInput').value = product.stock;
      document.getElementById('productCategoryInput').value = product.category;
      document.getElementById('productImageInput').value = product.imageUrl;
      document.getElementById('editProductId').value = product.id;
      document.getElementById('productModal').style.display = 'flex';
    }
    async function saveProduct() {
      const mode = document.getElementById('editMode').value;
      const id = document.getElementById('productIdInput').value.trim();
      const name = document.getElementById('productNameInput').value.trim();
      const description = document.getElementById('productDescInput').value.trim();
      const price = document.getElementById('productPriceInput').value;
      const discount = document.getElementById('productDiscountInput').value || 0;
      const stock = document.getElementById('productStockInput').value;
      const category = document.getElementById('productCategoryInput').value.trim();
      const imageUrl = document.getElementById('productImageInput').value.trim();
      if (!id || !name || !price || !stock || !category) return showToast('ID, Name, Price, Stock, Category required', 'error');
      showLoading('saveProductBtn');
      const action = mode === 'add' ? 'addProduct' : 'updateProduct';
      const payload = { action, token: adminToken, id, name, description, price, discount, stock, category, imageUrl };
      const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
      const data = await res.json();
      hideLoading('saveProductBtn', 'Save Product');
      if (data.status === 'success') {
        showToast(mode === 'add' ? 'Product added' : 'Product updated');
        closeModal('productModal');
        loadProducts();
      } else showToast(data.data, 'error');
    }
    async function deleteProduct(productId) {
      if (!confirm('Permanently deactivate this product?')) return;
      const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteProduct', token: adminToken, id: productId }) });
      const data = await res.json();
      if (data.status === 'success') { showToast('Product deactivated'); loadProducts(); } else showToast(data.data, 'error');
    }

    // Orders
    async function loadOrders() {
      try {
        const statusFilter = document.getElementById('orderStatusFilter').value;
        const payload = { action: 'getAllOrders', token: adminToken };
        if (statusFilter) payload.status = statusFilter;
        const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        const data = await res.json();
        if (data.status === 'success') { allOrders = data.data; renderOrdersTable(allOrders); }
      } catch(e) { showToast('Error loading orders', 'error'); }
    }
    function renderOrdersTable(orders) {
      let html = '';
      orders.forEach(o => {
        html += `<tr class="border-b">
          <td class="p-3 font-mono text-xs">${o.orderId}</td>
          <td class="p-3">${o.customerName}<br><span class="text-xs text-gray-500">${o.customerEmail}</span></td>
          <td class="p-3 font-bold">‚Çπ${o.total}</td>
          <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${getStatusColor(o.status)}">${o.status}</span></td>
          <td class="p-3">${new Date(o.date).toLocaleDateString()}</td>
          <td class="p-3"><button onclick="viewOrderItems('${o.orderId}')" class="text-blue-600 hover:text-blue-800 mr-2" title="View Items"><i class="fas fa-eye"></i></button><button onclick="openUpdateStatusModal('${o.orderId}','${o.status}')" class="text-amber-600 hover:text-amber-800" title="Update Status"><i class="fas fa-edit"></i></button></td>
        </tr>`;
      });
      document.getElementById('ordersTableBody').innerHTML = html || '<tr><td colspan="6" class="p-6 text-center text-gray-500">No orders found.</td></tr>';
    }
    // Filter listeners
    document.getElementById('orderStatusFilter')?.addEventListener('change', loadOrders);
    document.getElementById('orderSearch')?.addEventListener('input', function(e) {
      const term = e.target.value.toLowerCase();
      const filtered = allOrders.filter(o => o.orderId.toLowerCase().includes(term) || o.customerName.toLowerCase().includes(term) || o.customerEmail.toLowerCase().includes(term));
      renderOrdersTable(filtered);
    });

    function viewOrderItems(orderId) {
      const order = allOrders.find(o => o.orderId === orderId);
      if (!order) return;
      let itemsHtml = '';
      order.items.forEach(item => { itemsHtml += `<div class="flex justify-between items-center border-b pb-2"><div><span class="font-medium">${item.productName}</span> √ó ${item.quantity}</div><div class="font-semibold">‚Çπ${item.price * item.quantity}</div></div>`; });
      document.getElementById('orderItemsList').innerHTML = itemsHtml;
      document.getElementById('orderItemsModal').style.display = 'flex';
    }
    function openUpdateStatusModal(orderId, currentStatus) {
      document.getElementById('statusOrderId').value = orderId;
      document.getElementById('newOrderStatus').value = currentStatus;
      document.getElementById('updateStatusModal').style.display = 'flex';
    }
    async function updateOrderStatus() {
      const orderId = document.getElementById('statusOrderId').value;
      const status = document.getElementById('newOrderStatus').value;
      showLoading('updateStatusBtn');
      const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateOrderStatus', token: adminToken, orderId, status }) });
      const data = await res.json();
      hideLoading('updateStatusBtn', 'Update');
      if (data.status === 'success') { showToast('Order status updated'); closeModal('updateStatusModal'); loadOrders(); loadDashboard(); } else showToast(data.data, 'error');
    }

    // Settings
    async function updateAdminPassword() {
      const newPwd = document.getElementById('newAdminPassword').value;
      if (!newPwd) return showToast('Enter new password', 'error');
      const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateAdminPassword', token: adminToken, newPassword: newPwd }) });
      const data = await res.json();
      if (data.status === 'success') { showToast('Password updated'); document.getElementById('newAdminPassword').value = ''; } else showToast(data.data, 'error');
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = function(e) { if (e.target.classList.contains('fixed')) { document.querySelectorAll('.fixed').forEach(el => el.style.display = 'none'); } };
  </script>
</body>
</html>
